---
title: "Reactã®useReducerã‚’ä½¿ã£ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’è‰¯ã„æ„Ÿã˜ã«stateç®¡ç†ã—ãŸã„"
emoji: "ğŸ¥‘"
type: "tech"
topics: ["react", "typescript", "usereducer"]
published: true
---
## ã‚„ã‚ŠãŸã„ã“ã¨

é…åˆ—å†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸€ã¤ã®å ´åˆ

useStateã‚’ä½¿ã†ã€‚

```tsx
type User = {
  name: string
  age: number
}

const Form = () => {
  const [input, setInput] = useState<User>({ name: '', age: 0 })

  return (
   <form>
      <label>
        Name:
        <input
          name="name"
          onChange={(e) => setInput({ ...input, name: e.target.value })}
        />
      </label>
      <label>
        Age:
        <input
          name="age"
          onChange={(e) => setInput({ ...input, age: Number(e.target.value) })}
        />
      </label>
      <input type="submit" value="Submit" />
    </form>
  )
}
```

å¤šåˆ†ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã¨æ€ã†ã€‚
ãŸã ã—ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ˆã£ã¦ã¯ã€stateã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã‚’å…¥ã‚ŒãŸããªã‚‹ã¨ããŒã‚ã‚‹ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã®å ´åˆ

useReducerã‚’ä½¿ã†ã€‚

### Reducerã®è¨­å®š

```tsx
// Userã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®keyã¨valueã‚’ã‚»ãƒƒãƒˆã«ã—ãŸå‹ã‚’å®šç¾©
type UserKeyValue =
  | {
      key: 'name'
      value: string
    }
  | {
      key: 'age'
      value: number
    }

type ReducerAction =
  | ({
      type: 'set'
      index: number
    } & UserKeyValue)
  | { type: 'add' }
  | {
      type: 'remove'
      index: number
    }
  | {
      type: 'reset'
    }

const initialState: User = { name: '', age: 0 }

const reducer = (state: User[], action: ReducerAction) => {
  switch (action.type) {
    // ç¾åœ¨ã®é…åˆ—ã®å¾Œã‚ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€ã¤è¿½åŠ ã™ã‚‹
    case 'add':
      return [...state, initialState]

    // é…åˆ—å†…ã®indexã§æŒ‡å®šã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®keyã«valueã‚’ã‚»ãƒƒãƒˆã™ã‚‹
    case 'set':
      return [
        ...state.slice(0, action.index),
        { ...state[action.index], [action.key]: action.value },
        ...state.slice(action.index + 1),
      ]

    // é…åˆ—å†…ã®indexã§æŒ‡å®šã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã‹ã‚‰å‰Šé™¤ã™ã‚‹
    case 'remove':
      return [...state.slice(0, action.index), ...state.slice(action.index + 1)]

    // åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆ
    case 'reset':
      return [initialState]

    // ã“ã‚Œã¯ãªãã¦ã‚‚è‰¯ã„ã‹ã‚‚
    default:
      return state
  }
}
```

### useReducerã‚’ä½¿ã£ã¦formã‚’ä½œã‚‹

```tsx
const ReducerForm = () => {
  const [inputs, dispatch] = useReducer(reducer, [initialState])

  return (
    <form>
      {/* inputsã«ã¯Userã®é…åˆ—ãŒå…¥ã£ã¦ã„ã‚‹ */}
      {inputs.map((_, index) => (
        <InputUser
          index={index}
          inputs={inputs}
          dispatch={dispatch}
          key={index}
        />
      ))}
      <div>
        <button type="button" onClick={() => dispatch({ type: 'add' })}>
          è¿½åŠ 
        </button>
      </div>
      <div>
        <button type="button" onClick={() => dispatch({ type: 'reset' })}>
          ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>
      <div>
        <input type="submit" value="Submit" />
      </div>
    </form>
  )
}

const InputUser = ({
  index,
  inputs,
  dispatch,
}: {
  index: number
  inputs: User[]
  dispatch: React.Dispatch<UserInputsReducerAction>
}) => {
  return (
    <div>
      <label>
        Name:
        <input
          name="name"
          onChange={(e) =>
            dispatch({
              type: 'set',
              index: index,
              key: 'name',
              value: e.target.value,
            })
          }
          value={inputs[index].name}
        />
      </label>
      <label>
        Age:
        <input
          name="age"
          onChange={(e) =>
            dispatch({
              type: 'set',
              index: index,
              key: 'age',
              value: Number(e.target.value),
            })
          }
          value={inputs[index].age}
        />
      </label>
      <button type="button" onClick={() => dispatch({ type: 'remove', index })}>
        å‰Šé™¤
      </button>
    </div>
  )
}
```

ã“ã‚“ãªæ„Ÿã˜ã«æ›¸ã‘ã°OK
ãƒã‚¹ãƒˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ä¸Šæ‰‹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚Œã°æ“ä½œã§ãã‚‹ã€‚
useReducerä¾¿åˆ©ã€‚

### ãƒ‡ãƒ¢

@[codesandbox](https://codesandbox.io/embed/react-typescript-forked-i8igy?fontsize=14&hidenavigation=1&theme=dark)

consoleã§stateãŒæœŸå¾…ã—ãŸé€šã‚Šãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã§ãã¾ã™ã€‚


## ã¡ãªã¿ã«

### å®Ÿéš›ã«ä½¿ã†å ´é¢

ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã™ã‚‹ãŸã‚Userã®é…åˆ—ã‚’ç”¨ã„ã¦ã„ã‚‹ãŒã€å˜ãªã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã ã¨ã€Stateè‡ªä½“ã‚’åˆ†ã‘ã¦ç®¡ç†ã—ãŸã»ã†ãŒè‰¯ã„å ´åˆãŒå¤šãã†ã€‚
å®Ÿéš›ã¯ä¸‹è¨˜ã®ä¾‹ã®ã‚ˆã†ã«Userã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ã—ãŸè¤‡æ•°ã®é …ç›®ã‚’å…¥åŠ›ã—ãŸã„å ´åˆã§ã®ä½¿ç”¨ã‚’æƒ³å®šã—ã¦ã„ã‚‹ã€‚

```tsx
type User {
  name: string
  age: number
  details: UserDetail[]
}
// ã“ã®å ´åˆreducerã§ç®¡ç†ã™ã‚‹ã®ã¯ã€UserDetailã®é…åˆ—ã«ãªã‚‹
```

### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ¼ã¨ãƒãƒªãƒ¥ãƒ¼ã‚’ã‚»ãƒƒãƒˆã«ã—ãŸUnionTypeã‚’å®šç¾©ã™ã‚‹

ä¸Šè¨˜ã§ã‚„ã£ã¦ã‚‹ã‚ˆã†ã«UserKeyValueã‚’å®šç¾©ã™ã‚‹ã¨ã€propertyãŒå¢—ãˆãŸã¨ãã«è¾›ããªã‚‹ã€‚
ãªã®ã§ä¸‹è¨˜ã®ã‚ˆã†ã«å®šç¾©ã™ã‚‹ã¨è‰¯ã•ãã†ã€‚

```tsx
type KeyValueUnionTypeWithKey<T, K extends keyof T> = K extends keyof T
  ? { key: K; value: Pick<T, K>[K] }
  : never
type KeyValueUnion<T> = KeyValueUnionTypeWithKey<T, keyof T>

type UserKeyValue = KeyValueUnion<User>
// ã“ã‚“ãªæ„Ÿã˜ã«æœŸå¾…ã—ãŸçµæœãŒå¾—ã‚‰ã‚Œã‚‹
// {
//   key: "age";
//   value: number;
// } | {
//   key: "name";
//   value: string;
// }
```

ã“ã®éš›ã€æ¡ä»¶å¼ã‚’çœç•¥ã™ã‚‹ã¨æœŸå¾…ã—ãŸçµæœãŒå¾—ã‚‰ã‚Œãªã„ã®ã§æ³¨æ„ãŒå¿…è¦ã€‚

```tsx
type KeyValueUnionTypeWithKey<T, K extends keyof T> = {
  key: K
  value: Pick<T, K>[K]
}
type KeyValueUnion<T> = KeyValueUnionTypeWithKey<T, keyof T>

type UserKeyValue = KeyValueUnion<User>
// ã“ã†ãªã‚‹
// {
//   key: keyof User;
//   value: string | number;
// }
```
